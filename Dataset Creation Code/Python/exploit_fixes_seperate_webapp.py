import os
import json
import logging
from tqdm import tqdm

# --- Config ---
DATASET_DIR = r"C:\Users\Demo_\Downloads\armoureye\Datasets"
INPUT_FILE = os.path.join(DATASET_DIR, "final_enriched_dataset.jsonl")

# --- Output Files ---
# These new files will be smaller, containing only cve_id and links
EXPLOITS_FILE = os.path.join(DATASET_DIR, "cve_exploits_minimal.jsonl")
FIXES_FILE = os.path.join(DATASET_DIR, "cve_fixes_minimal.jsonl")

logging.basicConfig(level=logging.INFO, format="%(message)s")

# Counters
total_read = 0
total_exploits = 0
total_fixes = 0

logging.info(f"Reading from {INPUT_FILE}...")

try:
    # Read all lines into memory first to use tqdm with a total
    with open(INPUT_FILE, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    total_read = len(lines)

    # Open output files
    with open(EXPLOITS_FILE, 'w', encoding='utf-8') as f_exploits, \
         open(FIXES_FILE, 'w', encoding='utf-8') as f_fixes:
        
        for line in tqdm(lines, desc="Filtering CVEs"):
            if not line.strip():
                continue
            
            try:
                data = json.loads(line)
                cve_id = data.get("cve_id")
                
                if not cve_id:
                    continue

                # --- This is the changed logic ---

                # Check for exploits and write minimal record
                exploits_list = data.get("exploits")
                if exploits_list: 
                    minimal_record = {
                        "cve_id": cve_id,
                        "exploits": exploits_list
                    }
                    f_exploits.write(json.dumps(minimal_record) + "\n")
                    total_exploits += 1
                
                # Check for fixes and write minimal record
                fixes_list = data.get("fixes")
                if fixes_list:
                    minimal_record = {
                        "cve_id": cve_id,
                        "fixes": fixes_list
                    }
                    f_fixes.write(json.dumps(minimal_record) + "\n")
                    total_fixes += 1
                    
            except json.JSONDecodeError:
                logging.warning(f"Skipping bad JSON line: {line[:50]}...")

    logging.info("\n--- SUMMARY ---")
    logging.info(f"Total CVE records processed: {total_read}")
    logging.info(f"Wrote {total_exploits} records to {EXPLOITS_FILE}")
    logging.info(f"Wrote {total_fixes} records to {FIXES_FILE}")

except FileNotFoundError:
    logging.error(f"ERROR: Input file not found at {INPUT_FILE}")
except Exception as e:
    logging.error(f"An error occurred: {e}")